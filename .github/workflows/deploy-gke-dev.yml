name: Deploy to GKE (Dev)

on:
  push:
    branches: [dev]
    paths:
      - 'infra/gke/dev/**'
      - 'backend/**'
      - 'frontend/**'

  workflow_dispatch:

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      mongodb: ${{ steps.filter.outputs.mongodb }}
      ingress: ${{ steps.filter.outputs.ingress }}
      keycloak: ${{ steps.filter.outputs.keycloak }}
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            mongodb:
              - 'infra/gke/dev/mongodb/**'
            ingress:
              - 'infra/gke/dev/ingress/**'
            keycloak:
              - 'infra/gke/dev/keycloak/**'
            backend:
              - 'backend/**'
              - 'infra/gke/dev/backend/**'
            frontend:
              - 'frontend/**'
              - 'infra/gke/dev/frontend/**'

  deploy-mongodb:
    name: Deploy MongoDB (Dev)
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: >-
      always() && (
        github.event_name == 'workflow_dispatch' ||
        needs.detect-changes.outputs.mongodb == 'true'
      )
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/544685971138/locations/global/workloadIdentityPools/dragon-github-pool/providers/dragon-github-provider'
          service_account: 'dragon-deployer@fair-backbone-479312-h7.iam.gserviceaccount.com'

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: dragon-gke
          location: asia-southeast1-a

      - name: Create namespace
        run: kubectl create namespace dragon-dev --dry-run=client -o yaml | kubectl apply -f -

      - name: Create MongoDB secret
        run: |
          kubectl create secret generic mongodb-secret -n dragon-dev \
            --from-literal=MONGO_INITDB_ROOT_USERNAME=${{ secrets.MONGO_USERNAME }} \
            --from-literal=MONGO_INITDB_ROOT_PASSWORD=${{ secrets.MONGO_PASSWORD }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy MongoDB
        run: kubectl apply -f infra/gke/dev/mongodb/

      - name: Wait for MongoDB ready
        run: kubectl rollout status statefulset/mongodb -n dragon-dev --timeout=120s

      - name: Show status
        run: |
          kubectl get pods -n dragon-dev
          kubectl get svc -n dragon-dev
          kubectl get pvc -n dragon-dev

  deploy-ingress:
    name: Deploy Ingress (Dev)
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: >-
      always() && (
        github.event_name == 'workflow_dispatch' ||
        needs.detect-changes.outputs.ingress == 'true'
      )
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/544685971138/locations/global/workloadIdentityPools/dragon-github-pool/providers/dragon-github-provider'
          service_account: 'dragon-deployer@fair-backbone-479312-h7.iam.gserviceaccount.com'

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: dragon-gke
          location: asia-southeast1-a

      - name: Create namespace
        run: kubectl create namespace dragon-dev --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Ingress
        run: kubectl apply -f infra/gke/dev/ingress/

      - name: Show Ingress status
        run: |
          kubectl get ingress -n dragon-dev
          kubectl get managedcertificates -n dragon-dev

  deploy-keycloak:
    name: Deploy Keycloak (Dev)
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: >-
      always() && (
        github.event_name == 'workflow_dispatch' ||
        needs.detect-changes.outputs.keycloak == 'true'
      )
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/544685971138/locations/global/workloadIdentityPools/dragon-github-pool/providers/dragon-github-provider'
          service_account: 'dragon-deployer@fair-backbone-479312-h7.iam.gserviceaccount.com'

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: dragon-gke
          location: asia-southeast1-a

      - name: Create namespace
        run: kubectl create namespace dragon-dev --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Keycloak secret
        run: |
          kubectl create secret generic keycloak-secret -n dragon-dev \
            --from-literal=KEYCLOAK_ADMIN=${{ secrets.KEYCLOAK_ADMIN }} \
            --from-literal=KEYCLOAK_ADMIN_PASSWORD=${{ secrets.KEYCLOAK_ADMIN_PASSWORD }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Keycloak
        run: kubectl apply -f infra/gke/dev/keycloak/

      - name: Wait for Keycloak ready
        run: kubectl rollout status deployment/keycloak -n dragon-dev --timeout=600s

      - name: Show status
        run: |
          kubectl get pods -n dragon-dev
          kubectl get svc -n dragon-dev
          kubectl get pvc -n dragon-dev

  deploy-backend:
    name: Deploy Backend (Dev)
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: >-
      always() && (
        github.event_name == 'workflow_dispatch' ||
        needs.detect-changes.outputs.backend == 'true'
      )
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/544685971138/locations/global/workloadIdentityPools/dragon-github-pool/providers/dragon-github-provider'
          service_account: 'dragon-deployer@fair-backbone-479312-h7.iam.gserviceaccount.com'

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker asia-southeast1-docker.pkg.dev --quiet

      - name: Build and push Docker image
        run: |
          docker build -t asia-southeast1-docker.pkg.dev/fair-backbone-479312-h7/dragon-images/backend-dev:${{ github.sha }} \
            -t asia-southeast1-docker.pkg.dev/fair-backbone-479312-h7/dragon-images/backend-dev:latest \
            --target production \
            ./backend
          docker push asia-southeast1-docker.pkg.dev/fair-backbone-479312-h7/dragon-images/backend-dev:${{ github.sha }}
          docker push asia-southeast1-docker.pkg.dev/fair-backbone-479312-h7/dragon-images/backend-dev:latest

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: dragon-gke
          location: asia-southeast1-a

      - name: Create namespace
        run: kubectl create namespace dragon-dev --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Backend secret
        run: |
          DEV_MONGO_URI="mongodb://${{ secrets.MONGO_USERNAME }}:${{ secrets.MONGO_PASSWORD }}@mongodb.dragon-dev.svc.cluster.local:27017/dragon_dev?authSource=admin"
          kubectl create secret generic backend-secret -n dragon-dev \
            --from-literal=MONGO_URI="${DEV_MONGO_URI}" \
            --from-literal=KEYCLOAK_CLIENT_SECRET=${{ secrets.KEYCLOAK_CLIENT_SECRET }} \
            --from-literal=GEMINI_API_KEYS="${{ secrets.GEMINI_API_KEYS }}" \
            --from-literal=AI_PROVIDERS_CONFIG='${{ secrets.AI_PROVIDERS_CONFIG }}' \
            --from-literal=CORS_ORIGIN=https://dev.dragon-template.xyz \
            --from-literal=GCS_CREDENTIALS='${{ secrets.GCS_CREDENTIALS }}' \
            --from-literal=GCS_BUCKET=${{ secrets.GCS_BUCKET }} \
            --from-literal=GEMINI_IMAGE_MODEL=${{ secrets.GEMINI_IMAGE_MODEL }} \
            --from-literal=IMAGE_DEFAULT_ASPECT_RATIO=${{ secrets.IMAGE_DEFAULT_ASPECT_RATIO }} \
            --from-literal=IMAGE_DEFAULT_STYLE=${{ secrets.IMAGE_DEFAULT_STYLE }} \
            --from-literal=IMAGE_MAX_RETRIES=${{ secrets.IMAGE_MAX_RETRIES }} \
            --from-literal=IMAGE_TIMEOUT_MS=${{ secrets.IMAGE_TIMEOUT_MS }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Backend
        run: |
          kubectl set image deployment/backend backend=asia-southeast1-docker.pkg.dev/fair-backbone-479312-h7/dragon-images/backend-dev:${{ github.sha }} -n dragon-dev 2>/dev/null || true
          kubectl apply -f infra/gke/dev/backend/

      - name: Wait for Backend ready
        run: kubectl rollout status deployment/backend -n dragon-dev --timeout=120s

      - name: Show status
        run: |
          kubectl get pods -n dragon-dev
          kubectl get svc -n dragon-dev

  deploy-frontend:
    name: Deploy Frontend (Dev)
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: >-
      always() && (
        github.event_name == 'workflow_dispatch' ||
        needs.detect-changes.outputs.frontend == 'true'
      )
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/544685971138/locations/global/workloadIdentityPools/dragon-github-pool/providers/dragon-github-provider'
          service_account: 'dragon-deployer@fair-backbone-479312-h7.iam.gserviceaccount.com'

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker asia-southeast1-docker.pkg.dev --quiet

      - name: Build and push Docker image
        run: |
          docker build \
            --build-arg VITE_API_URL=https://dev-api.dragon-template.xyz \
            --build-arg VITE_KEYCLOAK_URL=https://dev-keycloak.dragon-template.xyz \
            -t asia-southeast1-docker.pkg.dev/fair-backbone-479312-h7/dragon-images/frontend-dev:${{ github.sha }} \
            -t asia-southeast1-docker.pkg.dev/fair-backbone-479312-h7/dragon-images/frontend-dev:latest \
            --target production \
            ./frontend
          docker push asia-southeast1-docker.pkg.dev/fair-backbone-479312-h7/dragon-images/frontend-dev:${{ github.sha }}
          docker push asia-southeast1-docker.pkg.dev/fair-backbone-479312-h7/dragon-images/frontend-dev:latest

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: dragon-gke
          location: asia-southeast1-a

      - name: Create namespace
        run: kubectl create namespace dragon-dev --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Frontend
        run: |
          kubectl set image deployment/frontend frontend=asia-southeast1-docker.pkg.dev/fair-backbone-479312-h7/dragon-images/frontend-dev:${{ github.sha }} -n dragon-dev 2>/dev/null || true
          kubectl apply -f infra/gke/dev/frontend/

      - name: Wait for Frontend ready
        run: kubectl rollout status deployment/frontend -n dragon-dev --timeout=120s

      - name: Show status
        run: |
          kubectl get pods -n dragon-dev
          kubectl get svc -n dragon-dev
